var canvas = document.getElementById("MainCanvas");
var context = canvas.getContext("2d");
var backgroundCanvas = document.getElementById("BackgroundCanvas");
var backgroundContext = canvas.getContext("2d");
var paused = true;
var backgroundFlakes = [];
var existingPiles = [];
var frameCounter = 0;
var flakes = [];
var piles = [];
var explosions = [];
var explosion_particles = [];
var snowball = {
    x: 0,
    y: 0,
    r: 0,
    history: [],
    t: 0
};
var mouse = {
    x: 0,
    y: 0,
    state: "up",
    speed: 0
};
var mouseVelocity = 0;
var explosionAngle;
var decreaseSize;
var gravity = -9.81;
var difTime;
var velocityCalculated = false;
var mouseClicked = false;
var aStep = 0.01;

var config = {
    flakesCount: 150,
    quickStart: false
};

function randomIntFromInterval(min, max) {
    return Math.random() * (max - min + 1) + min;
}

function degreesToRadians(angle) {
    return angle * (Math.PI / 180);
}

function resetVariables() {
    explosions = [];
    explosion_particles = [];
    difTime = 0;
    velocityCalculated = false;
    snowball.history = [];
}

function getVelocity(p1, p2) {
    var dist = Math.sqrt(Math.abs(p1.x - p2.x) + Math.abs(p1.y - p2.y));
    difTime = p2.t.getTime() - p1.t.getTime();
    var velocity = Math.floor(dist / difTime * difTime);
    if (velocity < 5) {
        velocity = 5;
    } else if (isNaN(velocity)) {
        velocity = 25;
    }
    return velocity;
}

document.addEventListener('DOMContentLoaded', function() {
    snowInit();
    window.requestAnimationFrame(UpdateCanvas);
    var canvas = document.getElementById('MainCanvas');
    resizeCanvas();

    canvas.classList.add("grabbable");

    window.addEventListener('mousedown', function(event) {
        mouse.state = "down";
    });

    window.addEventListener('mouseup', function(event) {
        mouse.state = "up";
    });

    window.addEventListener('mousemove', function(event) {
        if (mouse.state === "down") {
            var rect = canvas.getBoundingClientRect();
            mouse.x =
                (event.clientX - rect.left) * (canvas.width / canvas.offsetWidth);
            mouse.y =
                (event.clientY - rect.top) *
                (canvas.height / canvas.offsetHeight);
        }
    });
});

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    backgroundCanvas.width = window.innerWidth;
    backgroundCanvas.height = window.innerHeight;
}

function snowInit() {
    for (var i = 0; i < config.flakesCount; i++) {
        var flake = {
            x: Math.floor(Math.random() * canvas.width),
            y: Math.floor(Math.random() * canvas.height),
            r: Math.random() * 3 + 2,
            o: randomIntFromInterval(0.1, 0.5),
            s: randomIntFromInterval(2, 5)
        };
        flakes.push(flake);

        var backgroundFlake = {
            x: Math.floor(Math.random() * canvas.width),
            y: Math.floor(Math.random() * canvas.height),
            r: Math.random() * 3 + 2,
            o: randomIntFromInterval(0.1, 0.5),
            s: randomIntFromInterval(2, 5),
            a: randomIntFromInterval(0, Math.PI)
        };
        backgroundFlakes.push(backgroundFlake);

        if (config.quickStart) {
            piles.push({
                x: Math.floor(Math.random() * canvas.width),
                y: canvas.height,
                r: Math.random() * 100
            });
        }
    }
}

function UpdateCanvas() {
    // The UpdateCanvas function implementation goes here
    // ...
    window.requestAnimationFrame(UpdateCanvas);
}
